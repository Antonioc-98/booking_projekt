<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="./stylesheets/style.css" />
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
			rel="stylesheet" />
	</head>
	<header>
		<div class="izbornik">
			<div class="izbornik_1_2">
				<div class="izbornik_logo">
					<img src="./images/LOGO.svg" alt="" class="logo" />
				</div>
			</div>
			<div class="izbornik_2_2">
				<a href="/" class="izbornik_linkovi">
					<div class="izbornik_vanjski">
						<div class="izbornik_unutarnji">Poƒçetna</div>
					</div>
				</a>
				<a href="#onama" class="izbornik_linkovi">
					<div class="izbornik_vanjski">
						<div class="izbornik_unutarnji">O nama</div>
					</div>
				</a>
				<a href="/moje_rezervacije" class="izbornik_linkovi">
					<div class="izbornik_vanjski">
						<div class="izbornik_unutarnji">Moje rezervacije</div>
					</div>
				</a>
			</div>
		</div>
	</header>
	<body>
		<div class="kalendar">
			<% if(locals.dValue.length != 0) { %>
			<form
				action="/mb_1?query=<%=locals.tablicaValue%>"
				method="POST"
				class="kalendar_form">
				<div class="odaberi_datum">Odaberi datume</div>
				<div class="kalendar_rows">
					<% for (let i = 0; i < locals.dValue.length; i++) { %> <%
					if(locals.dStatus[i][0] === 1) { %>
					<div class="kalendar_unutarnji">
						<input
							type="checkbox"
							class="value-checkbox container"
							id="<%= locals.dId[i] %>"
							name="<%= locals.dId[i] %>"
							value="<%= locals.dValue[i] %>" />
						<label for="<%= locals.dId[i] %> " class="kalendar_info">
							<p class="cijena"><%= locals.dCijena[i] %></p>

							<div><%= locals.dValue[i] %></div>
							<div><%=`EUR ${locals.dCijena[i]}`%></div>
						</label>
					</div>
					<% } else { %>
					<div class="kalendar_unutarnji_nedostupno">
						<div><%= locals.dValue[i] %></div>
						<div>Nedostupno</div>
					</div>
					<%}%> <% } %>
				</div>
				<div class="stanje">
					<p id="discountMessage" style="font-size: 595; font-weight: bold"></p>
					<h3>Ukupna cijena: EUR <span id="totalSum">0</span></h3>
					<button type="submit" class="promijeni_btn" style="font-weight: bold">
						Rezerviraj
					</button>
				</div>
			</form>
			<% } else { %>
			<h1>Nema dostupnih datuma za rezervaciju</h1>
			<%}%>
		</div>

		<script>
			// Function to calculate and update total sum and discount
			function calculateTotal() {
				const checkboxes = document.querySelectorAll(".value-checkbox");
				const totalSumElement = document.getElementById("totalSum");
				const discountMessageElement =
					document.getElementById("discountMessage");
				let total = 0;
				let checkedCount = 0;

				// Iterate through all checkboxes to calculate total
				checkboxes.forEach((checkbox) => {
					if (checkbox.checked) {
						const price = parseFloat(
							checkbox.closest(".kalendar_unutarnji").querySelector(".cijena")
								.textContent
						);
						total += price; // Add the price from .cijena class
						checkedCount++;
					}
				});

				// Apply discount based on the number of checkboxes selected
				if (checkedCount >= 14) {
					total *= 0.8; // Apply 20% discount
					discountMessageElement.textContent = "20% popust!";
				} else if (checkedCount >= 3) {
					total *= 0.9; // Apply 10% discount
					discountMessageElement.textContent = "10% popust!";
				} else {
					discountMessageElement.textContent = "Bez popusta"; // No discount
				}

				// Update total sum display
				totalSumElement.textContent = total.toFixed(2);
			}

			// Function to handle the click on the div to toggle the checkbox
			function handleDivClick() {
				const kalendarRows = document.querySelectorAll(".kalendar_unutarnji");

				kalendarRows.forEach((row) => {
					row.addEventListener("click", (event) => {
						const checkbox = row.querySelector(".value-checkbox");

						if (checkbox) {
							// Toggle the checkbox checked state
							checkbox.checked = !checkbox.checked;

							// Recalculate the total and apply discounts
							calculateTotal();
						}
					});
				});
			}

			// Initialize the functionality
			document.addEventListener("DOMContentLoaded", () => {
				handleDivClick();

				// Add change event to checkboxes directly to ensure the total is calculated on checkbox toggle
				const checkboxes = document.querySelectorAll(".value-checkbox");
				checkboxes.forEach((checkbox) => {
					checkbox.addEventListener("change", calculateTotal);
				});
			});
		</script>
	</body>
</html>
